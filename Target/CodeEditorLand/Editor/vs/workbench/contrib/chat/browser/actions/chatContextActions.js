import{CancellationToken as j}from"../../../../../base/common/cancellation.js";import{Codicon as b}from"../../../../../base/common/codicons.js";import{KeyCode as X,KeyMod as G}from"../../../../../base/common/keyCodes.js";import{Schemas as h}from"../../../../../base/common/network.js";import{compare as H}from"../../../../../base/common/strings.js";import{ThemeIcon as d}from"../../../../../base/common/themables.js";import{URI as z}from"../../../../../base/common/uri.js";import"../../../../../editor/browser/editorExtensions.js";import"../../../../../editor/common/core/range.js";import{EditorType as F}from"../../../../../editor/common/editorCommon.js";import"../../../../../editor/common/languages.js";import{AbstractGotoSymbolQuickAccessProvider as B}from"../../../../../editor/contrib/quickAccess/browser/gotoSymbolQuickAccess.js";import{localize as C,localize2 as P}from"../../../../../nls.js";import{Action2 as S,MenuId as x,registerAction2 as E}from"../../../../../platform/actions/common/actions.js";import{ICommandService as Y}from"../../../../../platform/commands/common/commands.js";import{ContextKeyExpr as a}from"../../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as J}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import"../../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as Z}from"../../../../../platform/quickinput/common/quickInput.js";import{CHAT_CATEGORY as T}from"./chatActions.js";import{IChatWidgetService as ee,IQuickChatService as te,showChatView as R}from"../chat.js";import{isQuickChat as ie}from"../chatWidget.js";import{ChatContextAttachments as q}from"../contrib/chatContextAttachments.js";import{ChatAgentLocation as m,IChatAgentService as oe}from"../../common/chatAgents.js";import{CONTEXT_CHAT_LOCATION as f,CONTEXT_IN_CHAT_INPUT as ne}from"../../common/chatContextKeys.js";import"../../common/chatModel.js";import{ChatRequestAgentPart as V}from"../../common/chatParserTypes.js";import{IChatVariablesService as Q}from"../../common/chatVariables.js";import{ILanguageModelToolsService as ae}from"../../common/languageModelToolsService.js";import{AnythingQuickAccessProvider as re}from"../../../search/browser/anythingQuickAccess.js";import{SymbolsQuickAccessProvider as _}from"../../../search/browser/symbolsQuickAccess.js";import{IEditorService as U}from"../../../../services/editor/common/editorService.js";import{IClipboardService as ce}from"../../../../../platform/clipboard/common/clipboardService.js";import{imageToHash as L,isImage as se}from"../chatImagePaste.js";import{IConfigurationService as le}from"../../../../../platform/configuration/common/configuration.js";import{ActiveEditorContext as O}from"../../../../common/contextkeys.js";import{IViewsService as W}from"../../../../services/views/common/viewsService.js";function nt(){E(v),E(A),E(w)}class A extends S{static ID="workbench.action.chat.attachFile";constructor(){super({id:A.ID,title:P("workbench.action.chat.attachFile.label","Add File to Chat"),category:T,f1:!1,precondition:O.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:x.ChatCommandCenter,group:"a_chat",order:10}})}async run(i,...I){const s=i.get(Q),r=i.get(U),n=r.activeEditor?.resource;r.activeTextEditorControl?.getEditorType()===F.ICodeEditor&&n&&[h.file,h.vscodeRemote,h.untitled].includes(n.scheme)&&((await R(i.get(W)))?.focusInput(),s.attachContext("file",n,m.Panel))}}class w extends S{static ID="workbench.action.chat.attachSelection";constructor(){super({id:w.ID,title:P("workbench.action.chat.attachSelection.label","Add Selection to Chat"),category:T,f1:!1,precondition:O.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:x.ChatCommandCenter,group:"a_chat",order:11}})}async run(i,...I){const s=i.get(Q),r=i.get(U),n=r.activeTextEditorControl,e=r.activeEditor?.resource;if(r.activeTextEditorControl?.getEditorType()===F.ICodeEditor&&e&&[h.file,h.vscodeRemote,h.untitled].includes(e.scheme)){const c=n?.getSelection();c&&((await R(i.get(W)))?.focusInput(),s.attachContext("file",{uri:e,range:c},m.Panel))}}}class v extends S{static ID="workbench.action.chat.attachContext";static _cdt=a.or(a.and(f.isEqualTo(m.Panel)),a.and(f.isEqualTo(m.Editor),a.equals("config.chat.experimental.variables.editor",!0)),a.and(f.isEqualTo(m.Notebook),a.equals("config.chat.experimental.variables.notebook",!0)),a.and(f.isEqualTo(m.Terminal),a.equals("config.chat.experimental.variables.terminal",!0)));constructor(){super({id:v.ID,title:P("workbench.action.chat.attachContext.label","Attach Context"),icon:b.attach,category:T,precondition:a.or(v._cdt,a.and(f.isEqualTo(m.EditingSession))),keybinding:{when:ne,primary:G.CtrlCmd|X.Slash,weight:J.EditorContrib},menu:[{when:a.or(a.and(f.isEqualTo(m.EditingSession)),a.and(a.or(f.isEqualTo(m.Panel),f.isEqualTo(m.EditingSession)),v._cdt)),id:x.ChatInput,group:"navigation",order:2},{when:a.and(f.isEqualTo(m.Panel).negate(),v._cdt),id:x.ChatExecute,group:"navigation",order:1}]})}_getFileContextId(i){return"resource"in i?i.resource.toString():i.uri.toString()+(i.range.startLineNumber!==i.range.endLineNumber?`:${i.range.startLineNumber}-${i.range.endLineNumber}`:`:${i.range.startLineNumber}`)}async _attachContext(i,I,s,...r){const n=[];for(const e of r)if(e&&typeof e=="object"&&"command"in e&&e.command){const c=await I.executeCommand(e.command.id,...e.command.arguments??[]);if(!c)continue;n.push({...e,isDynamic:e.isDynamic,value:e.value,name:`${typeof e.value=="string"&&e.value.startsWith("#")?e.value.slice(1):""}${c}`,fullName:c})}else if("symbol"in e&&e.symbol)n.push({...e,id:this._getFileContextId(e.symbol.location),value:e.symbol.location,fullName:e.label,name:e.symbol.name,isDynamic:!0});else if(e&&typeof e=="object"&&"resource"in e&&e.resource)/\.(png|jpg|jpeg|bmp|gif|tiff)$/i.test(e.resource.path)?n.push({id:e.resource.toString(),name:e.label,fullName:e.label,value:e.resource,isDynamic:!0,isImage:!0}):n.push({...e,id:this._getFileContextId({resource:e.resource}),value:e.resource,name:e.label,isFile:!0,isDynamic:!0});else if("symbolName"in e&&e.uri&&e.range)n.push({...e,range:void 0,id:this._getFileContextId({uri:e.uri,range:e.range.decoration}),value:{uri:e.uri,range:e.range.decoration},fullName:e.label,name:e.symbolName,isDynamic:!0});else if("kind"in e&&e.kind==="tool")n.push({id:e.id,name:e.label,fullName:e.label,value:void 0,icon:e.icon,isTool:!0});else if("kind"in e&&e.kind==="image"){const c=await s.readImage();n.push({id:await L(c),name:C("pastedImage","Pasted Image"),fullName:C("pastedImage","Pasted Image"),value:c,isDynamic:!0,isImage:!0})}else n.push({...e,range:void 0,id:e.id??"",value:"value"in e?e.value:void 0,fullName:e.label,name:"name"in e&&typeof e.name=="string"?e.name:e.label,icon:"icon"in e&&d.isThemeIcon(e.icon)?e.icon:void 0});i.getContrib(q.ID)?.setContext(!1,...n)}async run(i,...I){const s=i.get(Z),r=i.get(oe),n=i.get(Q),e=i.get(Y),c=i.get(ee),o=i.get(ae),p=i.get(te),N=i.get(ce),K=i.get(le),g=I[0]?.widget??c.lastFocusedWidget;if(!g)return;const y=g.parsedInput.parts.find(t=>t instanceof V),M=y?y.agent.metadata.supportsSlowVariables:!0,k=[];for(const t of n.getVariables(g.location))t.fullName&&(!t.isSlow||M)&&k.push({label:t.fullName,name:t.name,id:t.id,iconClass:t.icon?d.asClassName(t.icon):void 0,icon:t.icon});if(K.getValue("chat.experimental.imageAttachments")){const t=await N.readImage();se(t)&&k.push({id:await L(t),kind:"image",label:C("imageFromClipboard","Image from Clipboard"),iconClass:d.asClassName(b.fileMedia)})}if(g.viewModel?.sessionId){const t=g.parsedInput.parts.find(l=>l instanceof V);if(t){const l=await r.getAgentCompletionItems(t.agent.id,"",j.None);for(const u of l)u.fullName&&k.push({label:u.fullName,id:u.id,command:u.command,icon:u.icon,iconClass:u.icon?d.asClassName(u.icon):void 0,value:u.value,isDynamic:!0,name:u.name})}}if(!y||y.agent.supportsToolReferences){for(const t of o.getTools())if(t.canBeInvokedManually){const l={kind:"tool",label:t.displayName??t.name??"",id:t.id,icon:d.isThemeIcon(t.icon)?t.icon:void 0};d.isThemeIcon(t.icon)?l.iconClass=d.asClassName(t.icon):t.icon&&(l.iconPath=t.icon),k.push(l)}}k.push({label:C("chatContext.symbol","Symbol..."),icon:d.fromId(b.symbolField.id),iconClass:d.asClassName(b.symbolField),prefix:_.PREFIX}),g.location===m.Notebook&&k.push({kind:"dynamic",id:"chatContext.notebook.kernelVariable",isDynamic:!0,icon:d.fromId(b.serverEnvironment.id),iconClass:d.asClassName(b.serverEnvironment),value:"kernelVariable",label:C("chatContext.notebook.kernelVariable","Kernel Variable..."),command:{id:"notebook.chat.selectAndInsertKernelVariable",title:C("chatContext.notebook.selectkernelVariable","Select and Insert Kernel Variable"),arguments:[{widget:g,range:void 0}]}});function D(t){if(!t)return"";const l=t.match(/\$\([^\)]+\)\s*(.+)/);return l?l[1]:t}this._show(s,e,g,p,k.sort(function(t,l){const u=D(t.label).toUpperCase(),$=D(l.label).toUpperCase();return H(u,$)}),N,"")}_show(i,I,s,r,n,e,c=""){i.quickAccess.show(c,{enabledProviderPrefixes:[re.PREFIX,_.PREFIX,B.PREFIX],placeholder:C("chatContext.attach.placeholder","Search attachments"),providerOptions:{handleAccept:o=>{if("prefix"in o)this._show(i,I,s,r,n,e,o.prefix);else{if(!e)return;this._attachContext(s,I,e,o),ie(s)&&r.open()}},additionPicks:n,filter:o=>{const p=s.getContrib(q.ID)?.getContext()??new Set;return"kind"in o&&o.kind==="image"?!p.has(o.id):"symbol"in o&&o.symbol?!p.has(this._getFileContextId(o.symbol.location)):o&&typeof o=="object"&&"resource"in o&&z.isUri(o.resource)?[h.file,h.vscodeRemote].includes(o.resource.scheme)&&!p.has(this._getFileContextId({resource:o.resource})):o&&typeof o=="object"&&"uri"in o&&o.uri&&o.range?!p.has(this._getFileContextId({uri:o.uri,range:o.range.decoration})):!("command"in o)&&o.id?!p.has(o.id):!0}}})}}export{nt as registerChatContextActions};
