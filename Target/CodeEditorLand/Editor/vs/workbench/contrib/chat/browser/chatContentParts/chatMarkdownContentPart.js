var O=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var g=(p,r,e,o)=>{for(var t=o>1?void 0:o?V(r,e):r,i=p.length-1,n;i>=0;i--)(n=p[i])&&(t=(o?n(r,e,t):n(t))||t);return o&&t&&O(r,e,t),t},c=(p,r)=>(e,o)=>r(e,o,p);import*as A from"../../../../../base/browser/dom.js";import{Emitter as q}from"../../../../../base/common/event.js";import"../../../../../base/common/htmlContent.js";import{Disposable as x}from"../../../../../base/common/lifecycle.js";import{equalsIgnoreCase as F}from"../../../../../base/common/strings.js";import"../../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{Range as K}from"../../../../../editor/common/core/range.js";import{ITextModelService as N}from"../../../../../editor/common/services/resolverService.js";import{MenuId as W}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as $}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as S}from"../../../../../platform/instantiation/common/instantiation.js";import"../chat.js";import{ResourcePool as z}from"./chatCollections.js";import"./chatContentParts.js";import"../chatListRenderer.js";import{ChatMarkdownDecorationsRenderer as G}from"../chatMarkdownDecorationsRenderer.js";import"../chatOptions.js";import{CodeBlockPart as J,localFileLanguageId as Q,parseLocalFileData as X}from"../codeBlockPart.js";import"../../common/annotations.js";import"../../common/chatModel.js";import{isRequestVM as Y,isResponseVM as k}from"../../common/chatViewModel.js";import"../../common/codeBlockModelCollection.js";import"../../../../../base/common/uri.js";import{IEditorService as Z}from"../../../../services/editor/common/editorService.js";import{InlineAnchorWidget as ee}from"../chatInlineAnchorWidget.js";const _=A.$;let a=class extends x{constructor(e,o,t,i=!1,n=0,I,m,oe,P,w,te,E,re){super();this.markdown=e;this.editorPool=t;this.codeBlockModelCollection=oe;this.textModelService=te;this.instantiationService=E;this.editorService=re;const l=o.element,j=E.createInstance(G),v=[];let U=n;const R=this._register(I.render(e,{fillInIncompleteTokens:i,codeBlockRendererSync:(u,y)=>{const f=U++;let b,B,D,M;if(F(u,Q))try{const d=X(y);B=d.range&&K.lift(d.range),b=this.textModelService.createModelReference(d.uri).then(h=>h.object)}catch{return _("div")}else{const d=k(l)||Y(l)?l.sessionId:"",h=this.codeBlockModelCollection.getOrCreate(d,l,f);D=h.vulns,M=h.codemapperUri,b=h.model}const H=k(l)&&l.errorDetails?.responseIsFiltered,s=this.renderCodeBlock({languageId:u,textModel:b,codeBlockIndex:f,element:l,range:B,hideToolbar:H,parentContextKeyService:w,vulns:D,codemapperUri:M},y,m,P.editableCodeBlock);this.allRefs.push(s),this._register(s.object.onDidChangeContentHeight(()=>this._onDidChangeHeight.fire()));const L=this.id,T=new class{ownerMarkdownPartId=L;codeBlockIndex=f;element=l;codemapperUri=void 0;get uri(){return s.object.uri}focus(){s.object.focus()}getContent(){return s.object.editor.getValue()}};return this.codeblocks.push(T),v.push(s),s.object.element},asyncRenderCallback:()=>this._onDidChangeHeight.fire()}));this._register(j.walkTreeAndAnnotateReferenceLinks(R.element)),v.reverse().forEach(u=>this._register(u)),this.domNode=R.element}static idPool=0;id=String(++a.idPool);domNode;allRefs=[];_onDidChangeHeight=this._register(new q);onDidChangeHeight=this._onDidChangeHeight.event;codeblocks=[];renderCodeBlock(e,o,t,i){const n=this.editorPool.get(),I=n.object;return k(e.element)&&this.codeBlockModelCollection.update(e.element.sessionId,e.element,e.codeBlockIndex,{text:o,languageId:e.languageId}).then(m=>{this.codeblocks[e.codeBlockIndex].codemapperUri=m.codemapperUri,this._onDidChangeHeight.fire()}),I.render(e,t,i),n}hasSameContent(e){return e.kind==="markdownContent"&&e.content.value===this.markdown.value}layout(e){this.allRefs.forEach((o,t)=>{const i=this.codeblocks[t];if(i.codemapperUri){const n=_(".chat-codeblock");this._register(this.instantiationService.createInstance(ee,n,{uri:i.codemapperUri},{handleClick:m=>this.editorService.openEditor({resource:m})})),o.object.element.parentElement?.querySelector(".chat-codeblock")||(o.object.element.parentElement?.appendChild(n),o.object.element.style.display="none")}else o.object.layout(e)})}addDisposable(e){this._register(e)}};a=g([c(9,$),c(10,N),c(11,S),c(12,Z)],a);let C=class extends x{_pool;inUse(){return this._pool.inUse}constructor(r,e,o,t){super(),this._pool=this._register(new z(()=>t.createInstance(J,r,W.ChatCodeBlock,e,o)))}get(){const r=this._pool.get();let e=!1;return{object:r,isStale:()=>e,dispose:()=>{r.reset(),e=!0,this._pool.release(r)}}}};C=g([c(3,S)],C);export{a as ChatMarkdownContentPart,C as EditorPool};
