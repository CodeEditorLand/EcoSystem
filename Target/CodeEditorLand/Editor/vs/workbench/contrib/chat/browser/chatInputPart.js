var dt=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var A=(E,S,t,o)=>{for(var i=o>1?void 0:o?lt(S,t):S,e=E.length-1,n;e>=0;e--)(n=E[e])&&(i=(o?n(S,t,i):n(i))||i);return o&&i&&dt(S,t,i),i},c=(E,S)=>(t,o)=>S(t,o,E);import*as s from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as ht}from"../../../../base/browser/fonts.js";import"../../../../base/browser/history.js";import{StandardKeyboardEvent as R}from"../../../../base/browser/keyboardEvent.js";import*as ct from"../../../../base/browser/ui/aria/aria.js";import{Button as T}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/hover/hover.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as K}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as ut}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{ProgressBar as pt}from"../../../../base/browser/ui/progressbar/progressbar.js";import"../../../../base/common/actions.js";import{Codicon as V}from"../../../../base/common/codicons.js";import{Emitter as M}from"../../../../base/common/event.js";import{HistoryNavigator2 as q}from"../../../../base/common/history.js";import{KeyCode as P}from"../../../../base/common/keyCodes.js";import{Disposable as gt,DisposableStore as F,MutableDisposable as mt}from"../../../../base/common/lifecycle.js";import{ResourceSet as ft}from"../../../../base/common/map.js";import{basename as vt,dirname as Ct}from"../../../../base/common/path.js";import{isMacintosh as bt}from"../../../../base/common/platform.js";import{URI as _}from"../../../../base/common/uri.js";import"../../../../editor/browser/config/editorConfiguration.js";import{EditorExtensionsRegistry as yt}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as Et}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorOptions as It}from"../../../../editor/common/config/editorOptions.js";import"../../../../editor/common/core/dimension.js";import"../../../../editor/common/core/position.js";import{Range as St}from"../../../../editor/common/core/range.js";import"../../../../editor/common/model.js";import{IModelService as _t}from"../../../../editor/common/services/model.js";import{CopyPasteController as Lt}from"../../../../editor/contrib/dropOrPasteInto/browser/copyPasteController.js";import{ContentHoverController as Mt}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as Dt}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{SuggestController as xt}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{localize as b}from"../../../../nls.js";import{IAccessibilityService as N}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as Ht}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as wt,MenuEntryActionViewItem as At}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as $,MenuWorkbenchToolBar as O}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as Tt,MenuId as k,MenuItemAction as B}from"../../../../platform/actions/common/actions.js";import{ICommandService as Pt}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Ft}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as W}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as Wt,IFileService as Vt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as Nt}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IHoverService as Ot}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as kt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Bt}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as U}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../platform/list/browser/listService.js";import{ILogService as Ut}from"../../../../platform/log/common/log.js";import{INotificationService as j}from"../../../../platform/notification/common/notification.js";import{IThemeService as X}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as Rt}from"../../../browser/labels.js";import{IEditorService as Kt}from"../../../services/editor/common/editorService.js";import{AccessibilityVerbositySettingId as G}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as qt}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as $t,getSimpleEditorOptions as zt,setupSimpleEditorSelectionStyling as jt}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as J,IChatAgentService as Xt}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as Gt,CONTEXT_CHAT_INPUT_HAS_FOCUS as Jt,CONTEXT_CHAT_INPUT_HAS_TEXT as Qt,CONTEXT_IN_CHAT_INPUT as Yt}from"../common/chatContextKeys.js";import{ChatEditingSessionState as Q,ModifiedFileEntryState as Y}from"../common/chatEditingService.js";import"../common/chatModel.js";import"../common/chatService.js";import"../common/chatViewModel.js";import{IChatWidgetHistoryService as Zt}from"../common/chatWidgetHistoryService.js";import{ILanguageModelsService as Z}from"../common/languageModels.js";import{CancelAction as te,ChatModelPickerActionId as ee,ChatSubmitSecondaryAgentAction as ie,SubmitAction as oe}from"./actions/chatExecuteActions.js";import"./chat.js";import"./chatContentParts/chatCollections.js";import{CollapsibleListPool as ne}from"./chatContentParts/chatReferencesContentPart.js";import{ChatEditingAcceptAllAction as tt,ChatEditingDiscardAllAction as et,ChatEditingShowChangesAction as it}from"./chatEditingService.js";import{ChatFollowups as se}from"./chatFollowups.js";import"./chatWidget.js";const D=s.$,ot=250;let x=class extends gt{constructor(t,o,i,e,n,h,a,p,u,f,C,y,d,g,r,v){super();this.location=t;this.options=o;this.getInputState=i;this.historyService=e;this.modelService=n;this.instantiationService=h;this.contextKeyService=a;this.configurationService=p;this.keybindingService=u;this.accessibilityService=f;this.languageModelsService=C;this.logService=y;this.hoverService=d;this.fileService=g;this.commandService=r;this.editorService=v;this.inputEditorMaxHeight=this.options.renderStyle==="compact"?ot/3:ot,this.inputEditorHasText=Qt.bindTo(a),this.chatCursorAtTop=Gt.bindTo(a),this.inputEditorHasFocus=Jt.bindTo(a),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new q([{text:""}],50,nt))),this._register(this.configurationService.onDidChangeConfiguration(I=>{I.affectsConfiguration(G.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})})),this._chatEditsListPool=this._register(this.instantiationService.createInstance(ne,this._onDidChangeVisibility.event,k.ChatEditingSessionWidgetToolbar,{enableFileDecorations:!0}))}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new M);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new M);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new M);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new M);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new M);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new M);onDidAcceptFollowup=this._onDidAcceptFollowup.event;get attachedContext(){return this._attachedContext}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_attachedContext=new Set;_onDidChangeVisibility=this._register(new M);_contextResourceLabels=this.instantiationService.createInstance(Rt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new F);attachedContextContainer;attachedContextDisposables=this._register(new F);chatEditingSessionWidgetContainer;_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_followupsHeight=0;get followupsHeight(){return this._followupsHeight}_inputEditor;_inputEditorElement;executeToolbar;inputActionsToolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inHistoryNavigation=!1;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;_waitForPersistedLanguageModel=this._register(new mt);_onDidChangeCurrentLanguageModel=new M;_currentLanguageModel;get currentLanguageModel(){return this._currentLanguageModel}cachedDimensions;cachedExecuteToolbarWidth;cachedInputToolbarWidth;inputUri=_.parse(`${x.INPUT_SCHEME}:input-${x._counter++}`);_chatEditsActionsDisposables=this._register(new F);_chatEditsDisposables=this._register(new F);_chatEditsProgress;_chatEditsListPool;_chatEditList;get selectedElements(){const t=[],i=this._chatEditList?.object?.getSelectedElements()??[];for(const e of i)e.kind==="reference"&&_.isUri(e.reference)&&t.push(e.reference);return t}setCurrentLanguageModelToDefault(){const t=this.languageModelsService.getLanguageModelIds().find(i=>this.languageModelsService.lookupLanguageModel(i)?.isDefault),o=this.languageModelsService.getLanguageModelIds().find(i=>{const e=this.languageModelsService.lookupLanguageModel(i);return e?.isUserSelectable&&!e.isDefault});this._currentLanguageModel=o?t:void 0}setCurrentLanguageModelByUser(t){this._currentLanguageModel=t,this._waitForPersistedLanguageModel.clear(),this.cachedDimensions&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)}loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new q(t,50,nt)}_getAriaLabel(){if(this.configurationService.getValue(G.Chat)){const o=this.keybindingService.lookupKeybinding(qt.OpenAccessibilityHelp)?.getLabel();return o?b("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",o):b("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return b("chatInput","Chat Input")}updateState(t){if(this.inHistoryNavigation)return;const o={text:this._inputEditor.getValue(),state:t};this.history.isAtEnd()?this.history.replaceLast(o):(this.history.replaceLast(o),this.history.resetCursor())}initForNewChatModel(t){this.history=this.loadHistory(),this.history.add({text:t.inputValue??this.history.current().text,state:t.inputState??this.getInputState()}),t.inputValue&&this.setValue(t.inputValue,!1),t.selectedLanguageModelId&&(this.languageModelsService.lookupLanguageModel(t.selectedLanguageModelId)?(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)):this._waitForPersistedLanguageModel.value=this.languageModelsService.onDidChangeLanguageModels(i=>{const e=i.added?.find(n=>n.identifier===t.selectedLanguageModelId);e&&(this._waitForPersistedLanguageModel.clear(),e.metadata.isUserSelectable&&(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)))}))}logInputHistory(){const t=[...this.history].map(o=>JSON.stringify(o)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const o=t?this.history.previous():this.history.next();ct.status(o.text),this.inHistoryNavigation=!0,this.setValue(o.text,!0),this.inHistoryNavigation=!1,this._onDidLoadInputState.fire(o.state);const i=this._inputEditor.getModel();if(i)if(t){const e=this._inputEditor._getViewModel()?.getLineLength(1)??1,n=i.getLineLength(1);e===n?this._inputEditor.setPosition({lineNumber:1,column:e+1}):this._inputEditor.setPosition({lineNumber:1,column:e})}else this._inputEditor.setPosition(st(i))}setValue(t,o){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),o||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const o={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(o)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const i={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(i),this.history.add({text:""})}this._attachedContext.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&bt?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}attachContext(t,...o){const i=[];if(t&&(i.push(...Array.from(this._attachedContext)),this._attachedContext.clear()),o.length>0)for(const e of o)this._attachedContext.add(e);(i.length>0||o.length>0)&&(this.initAttachedContext(this.attachedContextContainer),t||this._onDidChangeContext.fire({removed:i,added:o}))}render(t,o,i){let e;this.options.renderStyle==="compact"?e=s.h(".interactive-input-part",[s.h(".interactive-input-and-edit-session",[s.h(".chat-editing-session@chatEditingSessionWidgetContainer"),s.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[s.h(".chat-input-container@inputContainer",[s.h(".chat-editor-container@editorContainer"),s.h(".chat-input-toolbars@inputToolbars")])]),s.h(".chat-attached-context@attachedContextContainer"),s.h(".interactive-input-followups@followupsContainer")])]):e=s.h(".interactive-input-part",[s.h(".interactive-input-followups@followupsContainer"),s.h(".chat-editing-session@chatEditingSessionWidgetContainer"),s.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[s.h(".chat-input-container@inputContainer",[s.h(".chat-editor-container@editorContainer"),s.h(".chat-attached-context@attachedContextContainer"),s.h(".chat-input-toolbars@inputToolbars")])])]),this.container=e.root,t.append(this.container),this.container.classList.toggle("compact",this.options.renderStyle==="compact"),this.followupsContainer=e.followupsContainer;const n=e.inputAndSideToolbar,h=e.inputContainer,a=e.editorContainer;this.attachedContextContainer=e.attachedContextContainer;const p=e.inputToolbars;this.chatEditingSessionWidgetContainer=e.chatEditingSessionWidgetContainer,this.initAttachedContext(this.attachedContextContainer),this.renderChatEditingSessionState(null,void 0,i);const u=this._register(this.contextKeyService.createScoped(h));Yt.bindTo(u).set(!0);const f=this._register(this.instantiationService.createChild(new Bt([W,u]))),{historyNavigationBackwardsEnablement:C,historyNavigationForwardsEnablement:y}=this._register(Nt(u,this));this.historyNavigationBackwardsEnablement=C,this.historyNavigationForewardsEnablement=y;const d=zt(this.configurationService);d.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,d.pasteAs=It.pasteAs.defaultValue,d.readOnly=!1,d.ariaLabel=this._getAriaLabel(),d.fontFamily=ht,d.fontSize=13,d.lineHeight=20,d.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},d.cursorWidth=1,d.wrappingStrategy="advanced",d.bracketPairColorization={enabled:!1},d.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},d.scrollbar={...d.scrollbar??{},vertical:"hidden"},d.stickyScroll={enabled:!1},this._inputEditorElement=s.append(a,D(rt));const g=$t();g.contributions?.push(...yt.getSomeEditorContributions([Mt.ID,Dt.ID,Lt.ID])),this._inputEditor=this._register(f.createInstance(Et,this._inputEditorElement,d,g)),xt.get(this._inputEditor)?.forceRenderingAbove(),this._register(this._inputEditor.onDidChangeModelContent(()=>{const l=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);l!==this.inputEditorHeight&&(this.inputEditorHeight=l,this._onDidChangeHeight.fire());const m=this._inputEditor.getModel(),L=!!m&&m.getValue().trim().length>0;this.inputEditorHasText.set(L)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),h.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),h.classList.toggle("focused",!1),this._onDidBlur.fire()}));const r=this._register(K());if(this._register(s.addStandardDisposableListener(p,s.EventType.CLICK,l=>this.inputEditor.focus())),this.inputActionsToolbar=this._register(this.instantiationService.createInstance(O,p,k.ChatInput,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:$.Ignore,hoverDelegate:r})),this.inputActionsToolbar.context={widget:i},this._register(this.inputActionsToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedInputToolbarWidth=="number"&&this.cachedInputToolbarWidth!==this.inputActionsToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.executeToolbar=this._register(this.instantiationService.createInstance(O,p,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:r,hiddenItemStrategy:$.Ignore,actionViewItemProvider:(l,m)=>{if(this.location===J.Panel&&(l.id===oe.ID||l.id===te.ID)&&l instanceof B){const L=this.instantiationService.createInstance(B,{id:"chat.moreExecuteActions",title:b("notebook.moreExecuteActionsLabel","More..."),icon:V.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(H,l,L,m)}if(l.id===ee&&l instanceof B&&(this._currentLanguageModel||this.setCurrentLanguageModelToDefault(),this._currentLanguageModel)){const L={onDidChangeModel:this._onDidChangeCurrentLanguageModel.event,setModel:at=>{this.setCurrentLanguageModelByUser(at)}};return this.instantiationService.createInstance(w,l,this._currentLanguageModel,L,{hoverDelegate:m.hoverDelegate,keybinding:m.keybinding??void 0})}}})),this.executeToolbar.context={widget:i},this._register(this.executeToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedExecuteToolbarWidth=="number"&&this.cachedExecuteToolbarWidth!==this.executeToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const l=this._register(this.instantiationService.createInstance(O,n,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:r}));this.inputSideToolbarContainer=l.getElement(),l.getElement().classList.add("chat-side-toolbar"),l.context={widget:i}}let v=this.modelService.getModel(this.inputUri);if(v||(v=this.modelService.createModel("",null,this.inputUri,!0),this._register(v)),this.inputModel=v,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),o){this.inputModel.setValue(o);const l=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:l,column:this.inputModel.getLineMaxColumn(l)})}const I=()=>{const l=this._inputEditor.getModel();if(!l)return;const m=this._inputEditor.getPosition();if(!m)return;const L=m.lineNumber===1&&m.column-1<=(this._inputEditor._getViewModel()?.getLineLength(1)??0);this.chatCursorAtTop.set(L),this.historyNavigationBackwardsEnablement.set(L),this.historyNavigationForewardsEnablement.set(m.equals(st(l)))};this._register(this._inputEditor.onDidChangeCursorPosition(l=>I())),I()}initAttachedContext(t,o=!1){const i=t.offsetHeight;s.clearNode(t),this.attachedContextDisposables.clear();const e=this.attachedContextDisposables.add(K());s.setVisibility(!!this.attachedContext.size,this.attachedContextContainer),this.attachedContext.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),[...this.attachedContext.values()].forEach(async(n,h)=>{if(n.isFile&&this.location===J.EditingSession)return;const a=s.append(t,D(".chat-attached-context-attachment.show-file-icons")),p=this._contextResourceLabels.create(a,{supportIcons:!0,hoverDelegate:e});let u,f;const C=_.isUri(n.value)?n.value:n.value&&typeof n.value=="object"&&"uri"in n.value&&_.isUri(n.value.uri)?n.value.uri:void 0,y=n.value&&typeof n.value=="object"&&"range"in n.value&&St.isIRange(n.value.range)?n.value.range:void 0;if(C&&n.isFile){const d=vt(C.path),g=Ct(C.path),r=`${d} ${g}`;f=y?b("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",r,y.startLineNumber,y.endLineNumber):b("chat.fileAttachment","Attached file, {0}",r),u=C.fsPath,p.setFile(C,{fileKind:Wt.FILE,hidePath:!0,range:y}),this.attachButtonAndDisposables(a,h,n,e)}else if(n.isImage){f=b("chat.imageAttachment","Attached image, {0}",n.name),u=s.$("div.chat-attached-context-hover"),u.setAttribute("aria-label",f);const d=s.$("div.chat-attached-context-pill",{},s.$("span.codicon.codicon-file-media")),g=s.$("span.chat-attached-context-custom-text",{},n.name);a.appendChild(d),a.appendChild(g);let r;try{n.value instanceof _?(this.attachButtonAndDisposables(a,h,n,e),r=(await this.fileService.readFile(n.value)).value.buffer):(r=n.value,this.attachButtonAndDisposables(a,h,n,e)),this.createImageElements(r,a,u)}catch{}a.style.position="relative"}else{const d=n.fullName??n.name,g=n.icon?.id?`$(${n.icon.id}) ${d}`:d;p.setLabel(g,void 0),f=b("chat.attachment","Attached context, {0}",n.name),u=d,this.attachButtonAndDisposables(a,h,n,e)}a.tabIndex=0,a.ariaLabel=f,this.attachedContextDisposables.isDisposed||this.attachedContextDisposables.add(this.hoverService.setupManagedHover(e,a,u,{trapFocus:!1}))}),i!==t.offsetHeight&&!o&&this._onDidChangeHeight.fire()}attachButtonAndDisposables(t,o,i,e){const n=new T(t,{supportIcons:!0,hoverDelegate:e,title:b("chat.attachment.clearButton","Remove from context")});o===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachedContext.size-1)&&n.focus(),this.attachedContextDisposables.add(n),n.icon=V.close;const h=n.onDidClick(a=>{if(this._attachedContext.delete(i),h.dispose(),s.isKeyboardEvent(a)){const p=new R(a);(p.equals(P.Enter)||p.equals(P.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=o)}this._attachedContext.size===0&&this.focus(),this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[i]})});this.attachedContextDisposables.add(h)}createImageElements(t,o,i){const e=new Blob([t],{type:"image/png"}),n=URL.createObjectURL(e),h=s.$("img.chat-attached-context-image",{src:n,alt:""}),a=s.$("img.chat-attached-context-pill-image",{src:n,alt:""}),p=s.$("div.chat-attached-context-pill",{},a),u=o.querySelector(".chat-attached-context-pill");u&&u.replaceWith(p),i.appendChild(h)}async renderChatEditingSessionState(t,o,i){if(s.setVisibility(!!t||!!o,this.chatEditingSessionWidgetContainer),!t&&!o){s.clearNode(this.chatEditingSessionWidgetContainer),this._chatEditsDisposables.clear(),this._chatEditList=void 0,this._chatEditsProgress?.dispose(),this._chatEditsProgress=void 0;return}this._chatEditList&&t?.state.get()===Q.Idle&&(this._chatEditsProgress?.stop(),this._chatEditsProgress?.dispose(),this._chatEditsProgress=void 0);const e=this.chatEditingSessionWidgetContainer.querySelector(".chat-editing-session-container.show-file-icons")??s.append(this.chatEditingSessionWidgetContainer,D(".chat-editing-session-container.show-file-icons")),n=new ft,h=t?.entries.get().map(r=>(n.add(r.modifiedURI),{reference:r.modifiedURI,kind:"reference"}))??[];for(const r of this._attachedContext)r.isFile&&_.isUri(r.value)&&!n.has(r.value)&&(h.unshift({reference:r.value,kind:"reference"}),n.add(r.value));t?.workingSet.get().forEach(r=>{n.has(r)||h.unshift({reference:r,kind:"reference"})});const a=e.querySelector(".chat-editing-session-overview")??s.append(e,D(".chat-editing-session-overview"));if(h.length!==this._chatEditList?.object.length){const r=a.querySelector("span")??s.append(a,D("span"));r.textContent=b("chatEditingSession.workingSet","Working Set"),h.length===1?r.textContent+=" "+b("chatEditingSession.oneFile","(1 file)"):h.length>1&&(r.textContent+=" "+b("chatEditingSession.manyFiles","({0} files)",h.length))}this._chatEditsActionsDisposables.clear();const p=e.querySelector(".chat-editing-session-toolbar-actions")??s.append(a,D(".chat-editing-session-toolbar-actions")),u=this._chatEditsActionsDisposables.add(new T(p,{supportIcons:!1,secondary:!0}));u.label=b("chatAddFiles","Add Files..."),this._chatEditsActionsDisposables.add(u.onDidClick(()=>{this.commandService.executeCommand("workbench.action.chat.attachContext",{widget:i})})),s.append(p,u.element);const f=this._chatEditsActionsDisposables.add(new T(p,{supportIcons:!0}));if(f.icon=V.close,this._chatEditsActionsDisposables.add(f.onDidClick(r=>{this.commandService.executeCommand("workbench.action.chat.newEditSession")})),s.append(p,f.element),!t)return;if(!this._chatEditsProgress&&t.state.get()===Q.StreamingEdits&&(this._chatEditsProgress=new pt(e),this._chatEditsProgress.infinite().show(500)),!this._chatEditList){this._chatEditList=this._chatEditsListPool.get();const r=this._chatEditList.object;this._chatEditsDisposables.add(this._chatEditList),this._chatEditsDisposables.add(r.onDidOpen(v=>{if(v.element?.kind==="reference"&&_.isUri(v.element.reference)){const I=v.element.reference,l=t.entries.get().find(m=>m.modifiedURI.toString()===I.toString());l?.state.get()===Y.Undecided?this.editorService.openEditor({original:{resource:_.from(l.originalURI,!0)},modified:{resource:_.from(l.modifiedURI,!0)}}):l&&this.editorService.openEditor({resource:I})}})),s.append(e,r.getHTMLElement())}const d=Math.min(h.length,6)*22,g=this._chatEditList.object;g.layout(d),g.getHTMLElement().style.height=`${d}px`,g.splice(0,g.length,h);{const r=e.querySelector(".chat-editing-session-actions")??s.append(e,D(".chat-editing-session-actions"));s.clearNode(r);const v=r.querySelector(".chat-editing-session-actions-group")??D(".chat-editing-session-actions-group");if(t.entries.get().find(I=>I.state.get()===Y.Undecided)){const I=[];I.push({command:it.ID,label:it.LABEL,isSecondary:!0},{command:et.ID,label:et.LABEL,isSecondary:!0,container:v},{command:tt.ID,label:tt.LABEL,isSecondary:!1,container:v});for(const l of I){const m=this._chatEditsActionsDisposables.add(new T(l.container??r,{supportIcons:!1,secondary:l.isSecondary}));m.label=l.label,this._chatEditsActionsDisposables.add(m.onDidClick(()=>{this.commandService.executeCommand(l.command)})),s.append(l.container??r,m.element)}s.append(r,v)}}}async renderFollowups(t,o){this.options.renderFollowups&&(this.followupsDisposables.clear(),s.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(se,this.followupsContainer,t,this.location,void 0,i=>this._onDidAcceptFollowup.fire({followup:i,response:o}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.attachmentsHeight+t.toolbarsHeight+t.chatEditingStateHeight}layout(t,o){return this.cachedDimensions=new s.Dimension(o,t),this._layout(t,o)}previousInputEditorDimension;_layout(t,o,i=!0){this.initAttachedContext(this.attachedContextContainer,!0);const e=this.getLayoutData(),n=Math.min(e.inputPartEditorHeight,t-e.followupsHeight-e.attachmentsHeight-e.inputPartVerticalPadding-e.toolbarsHeight),h=o-e.inputPartHorizontalPadding;this.followupsContainer.style.width=`${h}px`,this._inputPartHeight=e.inputPartVerticalPadding+e.followupsHeight+n+e.inputEditorBorder+e.attachmentsHeight+e.toolbarsHeight+e.chatEditingStateHeight,this._followupsHeight=e.followupsHeight;const a=this._inputEditor.getScrollWidth(),u={width:o-e.inputPartHorizontalPadding-e.editorBorder-e.inputPartHorizontalPaddingInside-e.toolbarsWidth-e.sideToolbarWidth,height:n};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==u.width||this.previousInputEditorDimension.height!==u.height)&&(this._inputEditor.layout(u),this.previousInputEditorDimension=u),i&&a<10)return this._layout(t,o,!1)}getLayoutData(){const t=this.cachedExecuteToolbarWidth=this.executeToolbar.getItemsWidth(),o=this.cachedInputToolbarWidth=this.inputActionsToolbar.getItemsWidth(),i=(this.executeToolbar.getItemsLength()-1)*4,e=this.inputActionsToolbar.getItemsLength()?(this.inputActionsToolbar.getItemsLength()-1)*4:0;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?16:32,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:28,attachmentsHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,inputPartHorizontalPaddingInside:12,toolbarsWidth:this.options.renderStyle==="compact"?t+i+o+e:0,toolbarsHeight:this.options.renderStyle==="compact"?0:22,chatEditingStateHeight:this.chatEditingSessionWidgetContainer.offsetHeight,sideToolbarWidth:this.inputSideToolbarContainer?s.getTotalWidth(this.inputSideToolbarContainer)+4:0}}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};x=A([c(3,Zt),c(4,_t),c(5,kt),c(6,W),c(7,Ft),c(8,U),c(9,N),c(10,Z),c(11,Ut),c(12,Ot),c(13,Vt),c(14,Pt),c(15,Kt)],x);const nt=E=>JSON.stringify(E);function st(E){return{lineNumber:E.getLineCount(),column:E.getLineLength(E.getLineCount())+1}}let H=class extends Ht{constructor(S,t,o,i,e,n,h,a,p,u,f){super(S,t,[],"",{...o,getKeyBinding:d=>a.lookupKeybinding(d.id,h)},e,a,p,h,u,f);const C=i.createMenu(k.ChatExecuteSecondary,h),y=()=>{const d=[];wt(C,{shouldForwardArgs:!0},d);const g=n.getSecondaryAgent();g&&d.forEach(r=>(r.id===ie.ID&&(r.label=b("chat.submitToSecondaryAgent","Send to @{0}",g.name)),r)),this.update(t,d)};y(),this._register(C.onDidChange(()=>y()))}};H=A([c(3,Tt),c(4,z),c(5,Xt),c(6,W),c(7,U),c(8,j),c(9,X),c(10,N)],H);let w=class extends At{constructor(t,o,i,e,n,h,a,p,u,f,C){super(t,e,n,h,a,p,u,C);this.currentLanguageModel=o;this.delegate=i;this._languageModelsService=f;this._register(i.onDidChangeModel(y=>{this.currentLanguageModel=y,this.updateLabel()}))}async onClick(t){this._openContextMenu()}render(t){super.render(t),t.classList.add("chat-modelPicker-item"),this._register(s.addDisposableListener(t,s.EventType.KEY_UP,o=>{const i=new R(o);(i.equals(P.Enter)||i.equals(P.Space))&&this._openContextMenu()}))}updateLabel(){if(this.label){const t=this._languageModelsService.lookupLanguageModel(this.currentLanguageModel);t&&(this.label.textContent=t.name,s.reset(this.label,...ut(`${t.name}$(chevron-down)`)))}}_openContextMenu(){const t=(i,e)=>({id:i,label:e.name,tooltip:"",class:void 0,enabled:!0,checked:i===this.currentLanguageModel,run:()=>{this.currentLanguageModel=i,this.updateLabel(),this.delegate.setModel(i)}}),o=this._languageModelsService.getLanguageModelIds().map(i=>({id:i,model:this._languageModelsService.lookupLanguageModel(i)})).filter(i=>i.model?.isUserSelectable);this._contextMenuService.showContextMenu({getAnchor:()=>this.element,getActions:()=>o.map(i=>t(i.id,i.model))})}};w=A([c(4,U),c(5,j),c(6,W),c(7,X),c(8,z),c(9,Z),c(10,N)],w);const rt=".interactive-input-editor";jt(rt);export{x as ChatInputPart};
