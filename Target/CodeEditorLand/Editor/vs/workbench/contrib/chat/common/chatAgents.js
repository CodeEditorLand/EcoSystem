var b=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var C=(r,t,e,n)=>{for(var i=n>1?void 0:n?R(t,e):t,a=r.length-1,o;a>=0;a--)(o=r[a])&&(i=(n?o(t,e,i):o(i))||i);return n&&i&&b(t,e,i),i},l=(r,t)=>(e,n)=>t(e,n,r);import{findLast as x}from"../../../../base/common/arraysFind.js";import{timeout as w}from"../../../../base/common/async.js";import{CancellationToken as T}from"../../../../base/common/cancellation.js";import{Emitter as E}from"../../../../base/common/event.js";import{isMarkdownString as k}from"../../../../base/common/htmlContent.js";import{Iterable as I}from"../../../../base/common/iterator.js";import{toDisposable as m}from"../../../../base/common/lifecycle.js";import{revive as _}from"../../../../base/common/marshalling.js";import{observableValue as S}from"../../../../base/common/observable.js";import{equalsIgnoreCase as N}from"../../../../base/common/strings.js";import{ThemeIcon as q}from"../../../../base/common/themables.js";import"../../../../base/common/uri.js";import"../../../../editor/common/languages.js";import{ContextKeyExpr as D,IContextKeyService as M}from"../../../../platform/contextkey/common/contextkey.js";import{ExtensionIdentifier as L}from"../../../../platform/extensions/common/extensions.js";import{createDecorator as P}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as H}from"../../../../platform/log/common/log.js";import{IProductService as F}from"../../../../platform/product/common/productService.js";import{asJson as O,IRequestService as K}from"../../../../platform/request/common/request.js";import{IStorageService as B,StorageScope as A,StorageTarget as Q}from"../../../../platform/storage/common/storage.js";import{CONTEXT_CHAT_EDITING_PARTICIPANT_REGISTERED as W,CONTEXT_CHAT_ENABLED as $,CONTEXT_CHAT_PANEL_PARTICIPANT_REGISTERED as J}from"./chatContextKeys.js";import"./chatModel.js";import"./chatParticipantContribTypes.js";import"./chatService.js";var f=(a=>(a.Panel="panel",a.Terminal="terminal",a.Notebook="notebook",a.Editor="editor",a.EditingSession="editing-session",a))(f||{});(t=>{function r(e){switch(e){case"panel":return"panel";case"terminal":return"terminal";case"notebook":return"notebook";case"editor":return"editor";case"editing-session":return"editing-session"}return"panel"}t.fromRaw=r})(f||={});function Lt(r){return r&&q.isThemeIcon(r.icon)&&typeof r.title=="string"&&k(r.message)}const Ht=P("chatAgentService");let u=class{constructor(t){this.contextKeyService=t;this._hasDefaultAgent=$.bindTo(this.contextKeyService),this._defaultAgentRegistered=J.bindTo(this.contextKeyService),this._editingAgentRegistered=W.bindTo(this.contextKeyService)}static AGENT_LEADER="@";_agents=new Map;_onDidChangeAgents=new E;onDidChangeAgents=this._onDidChangeAgents.event;_hasDefaultAgent;_defaultAgentRegistered;_editingAgentRegistered;registerAgent(t,e){if(this.getAgent(t))throw new Error(`Agent already registered: ${JSON.stringify(t)}`);e.isDefault&&e.locations.includes("editing-session")?this._editingAgentRegistered.set(!0):e.isDefault&&this._defaultAgentRegistered.set(!0);const i=this,a=e.slashCommands;e={...e,get slashCommands(){return a.filter(g=>!g.when||i.contextKeyService.contextMatchesRules(D.deserialize(g.when)))}};const o={data:e};return this._agents.set(t,o),this._onDidChangeAgents.fire(void 0),m(()=>{this._agents.delete(t),e.isDefault&&e.locations.includes("editing-session")?this._editingAgentRegistered.set(!1):e.isDefault&&this._defaultAgentRegistered.set(!1),this._onDidChangeAgents.fire(void 0)})}registerAgentImplementation(t,e){const n=this._agents.get(t);if(!n)throw new Error(`Unknown agent: ${JSON.stringify(t)}`);if(n.impl)throw new Error(`Agent already has implementation: ${JSON.stringify(t)}`);return n.data.isDefault&&this._hasDefaultAgent.set(!0),n.impl=e,this._onDidChangeAgents.fire(new p(n.data,e)),m(()=>{n.impl=void 0,this._onDidChangeAgents.fire(void 0),n.data.isDefault&&this._hasDefaultAgent.set(!1)})}registerDynamicAgent(t,e){t.isDynamic=!0;const n={data:t,impl:e};return this._agents.set(t.id,n),this._onDidChangeAgents.fire(new p(t,e)),m(()=>{this._agents.delete(t.id),this._onDidChangeAgents.fire(void 0)})}_agentCompletionProviders=new Map;registerAgentCompletionProvider(t,e){return this._agentCompletionProviders.set(t,e),{dispose:()=>{this._agentCompletionProviders.delete(t)}}}async getAgentCompletionItems(t,e,n){return await this._agentCompletionProviders.get(t)?.(e,n)??[]}updateAgent(t,e){const n=this._agents.get(t);if(!n?.impl)throw new Error(`No activated agent with id ${JSON.stringify(t)} registered`);n.data.metadata={...n.data.metadata,...e},this._onDidChangeAgents.fire(new p(n.data,n.impl))}getDefaultAgent(t){return x(this.getActivatedAgents(),e=>!!e.isDefault&&e.locations.includes(t))}getContributedDefaultAgent(t){return this.getAgents().find(e=>!!e.isDefault&&e.locations.includes(t))}getSecondaryAgent(){return I.find(this._agents.values(),t=>!!t.data.metadata.isSecondary)?.data}getAgent(t){if(this._agentIsEnabled(t))return this._agents.get(t)?.data}_agentIsEnabled(t){const e=this._agents.get(t);return!e?.data.when||this.contextKeyService.contextMatchesRules(D.deserialize(e.data.when))}getAgentByFullyQualifiedId(t){const e=I.find(this._agents.values(),n=>z(n.data)===t)?.data;if(!(e&&!this._agentIsEnabled(e.id)))return e}getAgents(){return Array.from(this._agents.values()).map(t=>t.data).filter(t=>this._agentIsEnabled(t.id))}getActivatedAgents(){return Array.from(this._agents.values()).filter(t=>!!t.impl).filter(t=>this._agentIsEnabled(t.data.id)).map(t=>new p(t.data,t.impl))}getAgentsByName(t){return this.getAgents().filter(e=>e.name===t)}agentHasDupeName(t){const e=this.getAgent(t);return e?this.getAgentsByName(e.name).filter(n=>n.extensionId.value!==e.extensionId.value).length>0:!1}async invokeAgent(t,e,n,i,a){const o=this._agents.get(t);if(!o?.impl)throw new Error(`No activated agent with id "${t}"`);return await o.impl.invoke(e,n,i,a)}async getFollowups(t,e,n,i,a){const o=this._agents.get(t);if(!o?.impl)throw new Error(`No activated agent with id "${t}"`);return o.impl?.provideFollowups?o.impl.provideFollowups(e,n,i,a):[]}async getChatTitle(t,e,n){const i=this._agents.get(t);if(!i?.impl)throw new Error(`No activated agent with id "${t}"`);if(i.impl?.provideChatTitle)return i.impl.provideChatTitle(e,n)}_chatParticipantDetectionProviders=new Map;registerChatParticipantDetectionProvider(t,e){return this._chatParticipantDetectionProviders.set(t,e),m(()=>{this._chatParticipantDetectionProviders.delete(t)})}hasChatParticipantDetectionProviders(){return this._chatParticipantDetectionProviders.size>0}async detectAgentOrCommand(t,e,n,i){const a=I.first(this._chatParticipantDetectionProviders.values());if(!a)return;const o=this.getAgents().reduce((d,c)=>{d.push({participant:c.id,disambiguation:c.disambiguation??[]});for(const v of c.slashCommands)d.push({participant:c.id,command:v.name,disambiguation:v.disambiguation??[]});return d},[]),g=await a.provideParticipantDetection(t,e,{...n,participants:o},i);if(!g)return;const h=this.getAgent(g.participant);if(!h)return;if(!g.command)return{agent:h};const y=h?.slashCommands.find(d=>d.name===g.command);if(y)return{agent:h,command:y}}};u=C([l(0,M)],u);class p{constructor(t,e){this.data=t;this.impl=e}when;publisherDisplayName;isDynamic;get id(){return this.data.id}get name(){return this.data.name??""}get fullName(){return this.data.fullName??""}get description(){return this.data.description??""}get extensionId(){return this.data.extensionId}get extensionPublisherId(){return this.data.extensionPublisherId}get extensionPublisherDisplayName(){return this.data.publisherDisplayName}get extensionDisplayName(){return this.data.extensionDisplayName}get isDefault(){return this.data.isDefault}get metadata(){return this.data.metadata}get slashCommands(){return this.data.slashCommands}get locations(){return this.data.locations}get disambiguation(){return this.data.disambiguation}async invoke(t,e,n,i){return this.impl.invoke(t,e,n,i)}async provideFollowups(t,e,n,i){return this.impl.provideFollowups?this.impl.provideFollowups(t,e,n,i):[]}provideWelcomeMessage(t){if(this.impl.provideWelcomeMessage)return this.impl.provideWelcomeMessage(t)}provideSampleQuestions(t,e){if(this.impl.provideSampleQuestions)return this.impl.provideSampleQuestions(t,e)}toJSON(){return this.data}}const Ft=P("chatAgentNameService");let s=class{constructor(t,e,n,i){this.requestService=e;this.logService=n;this.storageService=i;if(!t.chatParticipantRegistry)return;this.url=t.chatParticipantRegistry;const a=i.get(s.StorageKey,A.APPLICATION);try{this.registry.set(JSON.parse(a??"{}"),void 0)}catch{i.remove(s.StorageKey,A.APPLICATION)}this.refresh()}static StorageKey="chat.participantNameRegistry";url;registry=S(this,Object.create(null));disposed=!1;refresh(){this.disposed||this.update().catch(t=>this.logService.warn("Failed to fetch chat participant registry",t)).then(()=>w(5*60*1e3)).then(()=>this.refresh())}async update(){const t=await this.requestService.request({type:"GET",url:this.url},T.None);if(t.res.statusCode!==200)throw new Error("Could not get extensions report.");const e=await O(t);if(!e||e.version!==1)throw new Error("Unexpected chat participant registry response.");const n=e.restrictedChatParticipants;this.registry.set(n,void 0),this.storageService.store(s.StorageKey,JSON.stringify(n),A.APPLICATION,Q.MACHINE)}getAgentNameRestriction(t){const e=this.checkAgentNameRestriction(t.name,t).get(),n=!t.fullName||this.checkAgentNameRestriction(t.fullName.replace(/\s/g,""),t).get();return e&&n}checkAgentNameRestriction(t,e){return this.registry.map(i=>i[t.toLowerCase()]).map(i=>i?i.some(a=>N(a,a.includes(".")?e.extensionId.value:e.extensionPublisherId)):!0)}dispose(){this.disposed=!0}};s=C([l(0,F),l(1,K),l(2,H),l(3,B)],s);function z(r){return`${r.extensionId.value}.${r.id}`}function Ot(r){const t="name"in r?r:{...r,name:r.id};return"extensionPublisherId"in t||(t.extensionPublisherId=t.extensionPublisher??""),"extensionDisplayName"in t||(t.extensionDisplayName=""),"extensionId"in t||(t.extensionId=new L("")),_(t)}export{f as ChatAgentLocation,s as ChatAgentNameService,u as ChatAgentService,Ft as IChatAgentNameService,Ht as IChatAgentService,p as MergedChatAgent,z as getFullyQualifiedId,Lt as isChatWelcomeMessageContent,Ot as reviveSerializedAgent};
