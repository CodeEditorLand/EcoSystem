var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var M=(g,e,t,i)=>{for(var s=i>1?void 0:i?ie(e,t):e,o=g.length-1,a;o>=0;o--)(a=g[o])&&(s=(i?a(e,t,s):a(s))||s);return i&&s&&te(e,t,s),s},n=(g,e)=>(t,i)=>e(t,i,g);import{$ as se,getActiveElement as ne,getTotalHeight as N,h,reset as E,trackFocus as oe}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{getDefaultHoverDelegate as re}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as F}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/common/actions.js";import{isNonEmptyArray as ae,tail as de}from"../../../../base/common/arrays.js";import{Emitter as B,Event as le}from"../../../../base/common/event.js";import{MarkdownString as he}from"../../../../base/common/htmlContent.js";import{DisposableStore as K,MutableDisposable as ce,toDisposable as ue}from"../../../../base/common/lifecycle.js";import{constObservable as L,derived as ge,observableValue as P}from"../../../../base/common/observable.js";import"./media/inlineChat.css";import"../../../../editor/browser/editorBrowser.js";import{AccessibleDiffViewer as pe}from"../../../../editor/browser/widget/diffEditor/components/accessibleDiffViewer.js";import{EditorOption as me}from"../../../../editor/common/config/editorOptions.js";import{LineRange as q}from"../../../../editor/common/core/lineRange.js";import"../../../../editor/common/core/position.js";import"../../../../editor/common/core/range.js";import{Selection as _e}from"../../../../editor/common/core/selection.js";import{DetailedLineRangeMapping as fe,RangeMapping as Ie}from"../../../../editor/common/diff/rangeMapping.js";import{ScrollType as ve}from"../../../../editor/common/editorCommon.js";import"../../../../editor/common/model.js";import{ITextModelService as U}from"../../../../editor/common/services/resolverService.js";import{localize as x}from"../../../../nls.js";import{IAccessibleViewService as X}from"../../../../platform/accessibility/browser/accessibleView.js";import{IAccessibilityService as G}from"../../../../platform/accessibility/common/accessibility.js";import{MenuWorkbenchButtonBar as be}from"../../../../platform/actions/browser/buttonbar.js";import{createActionViewItem as Ce}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as Se}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as O,MenuItemAction as Me}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as $}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as R}from"../../../../platform/contextkey/common/contextkey.js";import{IHoverService as z}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ye}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as j}from"../../../../platform/keybinding/common/keybinding.js";import{asCssVariable as we,asCssVariableName as Ee,editorBackground as Le,inputBackground as xe}from"../../../../platform/theme/common/colorRegistry.js";import{AccessibilityVerbositySettingId as H}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as Oe}from"../../accessibility/common/accessibilityCommands.js";import{MarkUnhelpfulActionId as Re}from"../../chat/browser/actions/chatTitleActions.js";import"../../chat/browser/chat.js";import{ChatVoteDownButton as We}from"../../chat/browser/chatListRenderer.js";import{ChatWidget as He}from"../../chat/browser/chatWidget.js";import{ChatAgentLocation as De}from"../../chat/common/chatAgents.js";import{chatRequestBackground as Ve}from"../../chat/common/chatColors.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as Ae,CONTEXT_RESPONSE as Te,CONTEXT_RESPONSE_ERROR as ke,CONTEXT_RESPONSE_FILTERED as Ne,CONTEXT_RESPONSE_VOTE as Fe}from"../../chat/common/chatContextKeys.js";import{ChatModel as Be}from"../../chat/common/chatModel.js";import{ChatAgentVoteDirection as J,IChatService as Q}from"../../chat/common/chatService.js";import{isResponseVM as c}from"../../chat/common/chatViewModel.js";import"./inlineChatSession.js";import{CTX_INLINE_CHAT_FOCUSED as Ke,CTX_INLINE_CHAT_RESPONSE_FOCUSED as Pe,inlineChatBackground as Y,inlineChatForeground as qe}from"../common/inlineChat.js";import{EDITOR_DRAG_AND_DROP_BACKGROUND as Ue}from"../../../common/theme.js";import{ILayoutService as Xe}from"../../../../platform/layout/browser/layoutService.js";let _=class{constructor(e,t,i,s,o,a,l,f,I,m,v){this._instantiationService=i;this._contextKeyService=s;this._keybindingService=o;this._accessibilityService=a;this._configurationService=l;this._accessibleViewService=f;this._textModelResolverService=I;this._chatService=m;this._hoverService=v;this.scopedContextKeyService=this._store.add(s.createScoped(this._elements.chatWidget));const p=i.createChild(new ye([R,this.scopedContextKeyService]),this._store);this._chatWidget=p.createInstance(He,e,void 0,{defaultElementHeight:32,renderStyle:"minimal",renderInputOnTop:!1,renderFollowups:!0,supportsFileReferences:l.getValue(`chat.experimental.variables.${e.location}`)===!0,filter:r=>c(r)&&r.isComplete&&!r.errorDetails?!(r.response.value.length>0&&r.response.value.every(d=>d.kind==="textEditGroup"&&t.chatWidgetViewOptions?.rendererOptions?.renderTextEditsAsSummary?.(d.uri))||r.response.value.length===0):!0,...t.chatWidgetViewOptions},{listForeground:qe,listBackground:Y,overlayBackground:Ue,inputEditorBackground:xe,resultEditorBackground:Le}),this._chatWidget.render(this._elements.chatWidget),this._elements.chatWidget.style.setProperty(Ee(Ve),we(Y)),this._chatWidget.setVisible(!0),this._store.add(this._chatWidget);const b=Te.bindTo(this.scopedContextKeyService),C=Fe.bindTo(this.scopedContextKeyService),D=Ae.bindTo(this.scopedContextKeyService),V=ke.bindTo(this.scopedContextKeyService),A=Ne.bindTo(this.scopedContextKeyService),w=this._store.add(new K);this._store.add(this._chatWidget.onDidChangeViewModel(()=>{w.clear();const r=this._chatWidget.viewModel;r&&(w.add(ue(()=>{S.context=void 0,b.reset(),C.reset(),V.reset(),A.reset(),D.reset()})),w.add(r.onDidChange(()=>{const d=r.getItems().at(-1);S.context=d,b.set(c(d)),C.set(c(d)?d.vote===J.Down?"down":d.vote===J.Up?"up":"":""),V.set(c(d)&&d.errorDetails!==void 0),A.set(!!(c(d)&&d.errorDetails?.responseIsFiltered)),D.set(c(d)&&(d.agent?.metadata.supportIssueReporting??!1)),this._onDidChangeHeight.fire()})),this._onDidChangeHeight.fire())})),this._store.add(this.chatWidget.onDidChangeContentHeight(()=>{this._onDidChangeHeight.fire()})),this._ctxResponseFocused=Pe.bindTo(this._contextKeyService);const T=this._store.add(oe(this.domNode));this._store.add(T.onDidBlur(()=>this._ctxResponseFocused.set(!1))),this._store.add(T.onDidFocus(()=>this._ctxResponseFocused.set(!0))),this._ctxInputEditorFocused=Ke.bindTo(s),this._store.add(this._chatWidget.inputEditor.onDidFocusEditorWidget(()=>this._ctxInputEditorFocused.set(!0))),this._store.add(this._chatWidget.inputEditor.onDidBlurEditorWidget(()=>this._ctxInputEditorFocused.set(!1)));const Z=t.statusMenuId instanceof O?t.statusMenuId:t.statusMenuId.menu,ee=t.statusMenuId instanceof O?void 0:t.statusMenuId.options,k=p.createInstance(be,this._elements.toolbar1,Z,{toolbarOptions:{primaryGroup:"0_main"},telemetrySource:t.chatWidgetViewOptions?.menus?.telemetrySource,menuOptions:{renderShortTitle:!0},...ee});this._store.add(k.onDidChange(()=>this._onDidChangeHeight.fire())),this._store.add(k);const S=p.createInstance(Se,this._elements.toolbar2,t.secondaryMenuId??O.for(""),{telemetrySource:t.chatWidgetViewOptions?.menus?.telemetrySource,menuOptions:{renderShortTitle:!0,shouldForwardArgs:!0},actionViewItemProvider:(r,d)=>r instanceof Me&&r.item.id===Re?p.createInstance(We,r,d):Ce(p,r,d)});this._store.add(S.onDidChangeMenuItems(()=>this._onDidChangeHeight.fire())),this._store.add(S),this._store.add(this._configurationService.onDidChangeConfiguration(r=>{r.affectsConfiguration(H.InlineChat)&&this._updateAriaLabel()})),this._elements.root.tabIndex=0,this._elements.statusLabel.tabIndex=0,this._updateAriaLabel(),this._store.add(this._hoverService.setupManagedHover(re("element"),this._elements.statusLabel,()=>this._elements.statusLabel.dataset.title)),this._store.add(this._chatService.onDidPerformUserAction(r=>{r.sessionId===this._chatWidget.viewModel?.model.sessionId&&r.action.kind==="vote"&&this.updateStatus("Thank you for your feedback!",{resetAfter:1250})})),this._defaultChatModel=this._store.add(this._instantiationService.createInstance(Be,void 0,De.Editor)),this._defaultChatModel.startInitialize(),this._defaultChatModel.initialize(void 0),this.setChatModel(this._defaultChatModel)}_elements=h("div.inline-chat@root",[h("div.chat-widget@chatWidget"),h("div.accessibleViewer@accessibleViewer"),h("div.status@status",[h("div.label.info.hidden@infoLabel"),h("div.actions.hidden@toolbar1"),h("div.label.status.hidden@statusLabel"),h("div.actions.secondary.hidden@toolbar2")])]);_store=new K;_defaultChatModel;_ctxInputEditorFocused;_ctxResponseFocused;_chatWidget;_onDidChangeHeight=this._store.add(new B);onDidChangeHeight=le.filter(this._onDidChangeHeight.event,e=>!this._isLayouting);_onDidChangeInput=this._store.add(new B);onDidChangeInput=this._onDidChangeInput.event;_isLayouting=!1;scopedContextKeyService;_updateAriaLabel(){if(this._elements.root.ariaLabel=this._accessibleViewService.getOpenAriaHint(H.InlineChat),this._accessibilityService.isScreenReaderOptimized()){let e=Ge;if(this._configurationService.getValue(H.InlineChat)){const t=this._keybindingService.lookupKeybinding(Oe.OpenAccessibilityHelp)?.getLabel();e=t?x("inlineChat.accessibilityHelp","Inline Chat Input, Use {0} for Inline Chat Accessibility Help.",t):x("inlineChat.accessibilityHelpNoKb","Inline Chat Input, Run the Inline Chat Accessibility Help command for more information.")}this._chatWidget.inputEditor.updateOptions({ariaLabel:e})}}dispose(){this._store.dispose()}get domNode(){return this._elements.root}get chatWidget(){return this._chatWidget}saveState(){this._chatWidget.saveState()}layout(e){this._isLayouting=!0;try{this._doLayout(e)}finally{this._isLayouting=!1}}_doLayout(e){const t=this._getExtraHeight(),i=N(this._elements.status);this._elements.root.style.height=`${e.height-t}px`,this._elements.root.style.width=`${e.width}px`,this._chatWidget.layout(e.height-i-t,e.width)}get contentHeight(){const e={chatWidgetContentHeight:this._chatWidget.contentHeight,statusHeight:N(this._elements.status),extraHeight:this._getExtraHeight()};return e.chatWidgetContentHeight+e.statusHeight+e.extraHeight}get minHeight(){let e=100;for(const i of this._chatWidget.viewModel?.getItems()??[])if(c(i)&&i.response.value.some(s=>s.kind==="textEditGroup"&&!s.state?.applied)){e=270;break}let t=this.contentHeight;return t-=this._chatWidget.contentHeight,t+=Math.min(this._chatWidget.input.contentHeight+e,this._chatWidget.contentHeight),t}_getExtraHeight(){return 6}get value(){return this._chatWidget.getInput()}set value(e){this._chatWidget.setInput(e)}selectAll(e=!0){let t=1;if(!e){const i=/^(\/\w+)\s*/.exec(this._chatWidget.inputEditor.getModel().getLineContent(1));i&&(t=i[1].length+1)}this._chatWidget.inputEditor.setSelection(new _e(1,t,Number.MAX_SAFE_INTEGER,1))}set placeholder(e){this._chatWidget.setInputPlaceholder(e)}toggleStatus(e){this._elements.toolbar1.classList.toggle("hidden",!e),this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("hidden",!e),this._elements.infoLabel.classList.toggle("hidden",!e),this._onDidChangeHeight.fire()}updateToolbar(e){this._elements.root.classList.toggle("toolbar",e),this._elements.toolbar1.classList.toggle("hidden",!e),this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("actions",e),this._elements.infoLabel.classList.toggle("hidden",e),this._onDidChangeHeight.fire()}async getCodeBlockInfo(e){const{viewModel:t}=this._chatWidget;if(!t)return;const i=t.getItems().filter(o=>c(o));if(!i.length)return;const s=i[i.length-1];return t.codeBlockModelCollection.get(t.sessionId,s,e)?.model}get responseContent(){const e=this._chatWidget.viewModel?.model.getRequests();if(ae(e))return de(e)?.response?.response.toString()}getChatModel(){return this._chatWidget.viewModel?.model??this._defaultChatModel}setChatModel(e){this._chatWidget.setModel(e,{inputValue:void 0})}updateChatMessage(e,t,i){if(!this._chatWidget.viewModel||this._chatWidget.viewModel.model!==this._defaultChatModel)return;const s=this._defaultChatModel;if(!e?.message.value){for(const a of s.getRequests())s.removeRequest(a.id);return}const o=s.addRequest({parts:[],text:""},{variables:[]},0);if(s.acceptResponseProgress(o,{kind:"markdownContent",content:e.message}),!t){s.completeResponse(o);return}return{cancel:()=>s.cancelRequest(o),complete:()=>s.completeResponse(o),appendContent:a=>{s.acceptResponseProgress(o,{kind:"markdownContent",content:new he(a)})}}}updateInfo(e){this._elements.infoLabel.classList.toggle("hidden",!e);const t=F(e);E(this._elements.infoLabel,...t),this._onDidChangeHeight.fire()}updateStatus(e,t={}){const i=typeof t.resetAfter=="number";if(i&&!this._elements.statusLabel.dataset.state){const o=this._elements.statusLabel.innerText,a=this._elements.statusLabel.dataset.title,l=Array.from(this._elements.statusLabel.classList.values());setTimeout(()=>{this.updateStatus(o,{classes:l,keepMessage:!0,title:a})},t.resetAfter)}const s=F(e);E(this._elements.statusLabel,...s),this._elements.statusLabel.className=`label status ${(t.classes??[]).join(" ")}`,this._elements.statusLabel.classList.toggle("hidden",!e),i?this._elements.statusLabel.dataset.state="temp":delete this._elements.statusLabel.dataset.state,t.title?this._elements.statusLabel.dataset.title=t.title:delete this._elements.statusLabel.dataset.title,this._onDidChangeHeight.fire()}reset(){this._chatWidget.setContext(!0),this._chatWidget.saveState(),this.updateChatMessage(void 0),E(this._elements.statusLabel),this._elements.statusLabel.classList.toggle("hidden",!0),this._elements.toolbar1.classList.add("hidden"),this._elements.toolbar2.classList.add("hidden"),this.updateInfo(""),this.chatWidget.setModel(this._defaultChatModel,{}),this._elements.accessibleViewer.classList.toggle("hidden",!0),this._onDidChangeHeight.fire()}focus(){this._chatWidget.focusInput()}hasFocus(){return this.domNode.contains(ne())}};_=M([n(2,W),n(3,R),n(4,j),n(5,G),n(6,$),n(7,X),n(8,U),n(9,Q),n(10,z)],_);const Ge=x("aria-label","Inline Chat Input");let y=class extends _{constructor(t,i,s,o,a,l,f,I,m,v,p,b,C){super(t,{...s,chatWidgetViewOptions:{...s.chatWidgetViewOptions,editorOverflowWidgetsDomNode:C.mainContainer.appendChild(se(".inline-chat-overflow.monaco-editor"))}},l,o,a,f,I,m,v,p,b);this._parentEditor=i}_accessibleViewer=this._store.add(new ce);get contentHeight(){let t=super.contentHeight;return this._accessibleViewer.value&&(t+=this._accessibleViewer.value.height+8),t}_doLayout(t){let i=t.height;this._accessibleViewer.value&&(this._accessibleViewer.value.width=t.width-12,i-=this._accessibleViewer.value.height+8),super._doLayout(t.with(void 0,i)),this._elements.root.style.height=`${t.height-this._getExtraHeight()}px`}reset(){this._accessibleViewer.clear(),super.reset()}showAccessibleHunk(t,i){this._elements.accessibleViewer.classList.remove("hidden"),this._accessibleViewer.clear(),this._accessibleViewer.value=this._instantiationService.createInstance(u,this._elements.accessibleViewer,t,i,new $e(this._parentEditor,t,i)),this._onDidChangeHeight.fire()}};y=M([n(3,R),n(4,j),n(5,W),n(6,G),n(7,$),n(8,X),n(9,U),n(10,Q),n(11,z),n(12,Xe)],y);let u=class extends pe{height;set width(e){this._width2.set(e,void 0)}_width2;constructor(e,t,i,s,o){const a=P("width",0),l=P("diff",u._asMapping(i)),f=ge(v=>[l.read(v)]),I=Math.min(10,8+l.get().changedLineCount),m=s.getModifiedOptions().get(me.lineHeight)*I;super(e,L(!0),()=>{},L(!1),a,L(m),f,s,o),this.height=m,this._width2=a,this._store.add(t.textModelN.onDidChangeContent(()=>{l.set(u._asMapping(i),void 0)}))}static _asMapping(e){const t=e.getRanges0(),i=e.getRangesN(),s=q.fromRangeInclusive(t[0]),o=q.fromRangeInclusive(i[0]),a=[];for(let l=1;l<t.length;l++)a.push(new Ie(t[l],i[l]));return new fe(s,o,a)}};u=M([n(4,W)],u);class $e{constructor(e,t,i){this._editor=e;this._session=t;this._hunk=i}getOriginalModel(){return this._session.textModel0}getModifiedModel(){return this._session.textModelN}getOriginalOptions(){return this._editor.getOptions()}getModifiedOptions(){return this._editor.getOptions()}originalReveal(e){}modifiedReveal(e){this._editor.revealRangeInCenterIfOutsideViewport(e||this._hunk.getRangesN()[0],ve.Smooth)}modifiedSetSelection(e){}modifiedFocus(){this._editor.focus()}getModifiedPosition(){return this._hunk.getRangesN()[0].getStartPosition()}}export{y as EditorBasedInlineChatWidget,_ as InlineChatWidget};
