var w=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var f=(d,o,e,t)=>{for(var i=t>1?void 0:t?C(o,e):o,n=d.length-1,l;n>=0;n--)(l=d[n])&&(i=(t?l(o,e,i):l(i))||i);return t&&i&&w(o,e,i),i},c=(d,o)=>(e,t)=>o(e,t,d);import{addDisposableListener as E,Dimension as T}from"../../../../base/browser/dom.js";import*as y from"../../../../base/browser/ui/aria/aria.js";import{MutableDisposable as L,toDisposable as N}from"../../../../base/common/lifecycle.js";import{isEqual as O}from"../../../../base/common/resources.js";import{assertType as x}from"../../../../base/common/types.js";import"../../../../editor/browser/editorBrowser.js";import{StableEditorBottomScrollState as I}from"../../../../editor/browser/stableEditorScroll.js";import{EditorOption as S}from"../../../../editor/common/config/editorOptions.js";import"../../../../editor/common/core/position.js";import"../../../../editor/common/core/range.js";import{ScrollType as b}from"../../../../editor/common/editorCommon.js";import{ZoneWidget as P}from"../../../../editor/contrib/zoneWidget/browser/zoneWidget.js";import{localize as A}from"../../../../nls.js";import{IConfigurationService as H}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as U}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as W}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService as D}from"../../../../platform/log/common/log.js";import"../../chat/browser/chatWidget.js";import{isResponseVM as R}from"../../chat/common/chatViewModel.js";import{ACTION_REGENERATE_RESPONSE as M,ACTION_REPORT_ISSUE as V,ACTION_TOGGLE_DIFF as F,CTX_INLINE_CHAT_OUTER_CURSOR_POSITION as K,EditMode as B,InlineChatConfigKeys as G,MENU_INLINE_CHAT_WIDGET_SECONDARY as Z,MENU_INLINE_CHAT_WIDGET_STATUS as k}from"../common/inlineChat.js";import{EditorBasedInlineChatWidget as z}from"./inlineChatWidget.js";let m=class extends P{constructor(e,t,i,n,l,g){super(t,{showFrame:!1,showArrow:!1,isAccessible:!0,className:"inline-chat-widget",keepEditorSelection:!0,showInHiddenAreas:!0,ordinal:5e4});this._instaService=i;this._logService=n;this._ctxCursorPosition=K.bindTo(l),this._disposables.add(N(()=>{this._ctxCursorPosition.reset()})),this.widget=this._instaService.createInstance(z,e,this.editor,{statusMenuId:{menu:k,options:{buttonConfigProvider:(s,p)=>{const h=p>0;return new Set([M,F,V]).has(s.id)?{isSecondary:h,showIcon:!0,showLabel:!1}:{isSecondary:h}}}},secondaryMenuId:Z,chatWidgetViewOptions:{menus:{telemetrySource:"interactiveEditorWidget-toolbar"},rendererOptions:{renderTextEditsAsSummary:s=>O(s,t.getModel()?.uri)&&g.getValue(G.Mode)===B.Live}}}),this._disposables.add(this.widget);let a;this._disposables.add(this.widget.chatWidget.onWillMaybeChangeHeight(()=>{this.position&&(a=this._createZoneAndScrollRestoreFn(this.position))})),this._disposables.add(this.widget.onDidChangeHeight(()=>{if(this.position){a??=this._createZoneAndScrollRestoreFn(this.position);const s=this._computeHeight();this._relayout(s.linesValue),a(),a=void 0}})),this.create(),this._disposables.add(E(this.domNode,"click",s=>{!this.editor.hasWidgetFocus()&&!this.widget.hasFocus()&&this.editor.focus()},!0));const r=()=>{!this.position||!this.editor.hasModel()?this._ctxCursorPosition.reset():this.position.lineNumber===this.editor.getPosition().lineNumber?this._ctxCursorPosition.set("above"):this.position.lineNumber+1===this.editor.getPosition().lineNumber?this._ctxCursorPosition.set("below"):this._ctxCursorPosition.reset()};this._disposables.add(this.editor.onDidChangeCursorPosition(s=>r())),this._disposables.add(this.editor.onDidFocusEditorText(s=>r())),r()}widget;_scrollUp=this._disposables.add(new q(this.editor));_ctxCursorPosition;_dimension;_fillContainer(e){e.appendChild(this.widget.domNode)}_doLayout(e){const t=this.editor.getLayoutInfo();let i=t.contentWidth-(t.glyphMarginWidth+t.decorationsWidth);i=Math.min(640,i),this._dimension=new T(i,e),this.widget.layout(this._dimension)}_computeHeight(){const e=this.widget.contentHeight,t=this.editor.getLayoutInfo().height,i=Math.min(e,Math.max(this.widget.minHeight,t*.42));return{linesValue:i/this.editor.getOption(S.lineHeight),pixelsValue:i}}_onWidth(e){this._dimension&&this._doLayout(this._dimension.height)}show(e){x(this.container);const t=this.editor.getLayoutInfo(),i=t.glyphMarginWidth+t.decorationsWidth+t.lineNumbersWidth;this.container.style.marginLeft=`${i}px`;const n=this._createZoneAndScrollRestoreFn(e);super.show(e,this._computeHeight().linesValue),this.widget.chatWidget.setVisible(!0),this.widget.focus(),n(),this._scrollUp.enable()}reveal(e){const t=this.editor.getOption(S.stickyScroll),i=t.enabled?t.maxLineCount:0;this.editor.revealLines(e.lineNumber+i,e.lineNumber+i,b.Immediate),this._scrollUp.reset(),this.updatePositionAndHeight(e)}updatePositionAndHeight(e){const t=this._createZoneAndScrollRestoreFn(e);super.updatePositionAndHeight(e,this._computeHeight().linesValue),t()}_createZoneAndScrollRestoreFn(e){const t=I.capture(this.editor),i=e.lineNumber<=1?1:1+e.lineNumber,n=this.editor.getScrollTop(),g=this.editor.getTopForLineNumber(i)-this._computeHeight().pixelsValue;return this.widget.chatWidget.viewModel?.getItems().find(r=>R(r)&&r.response.value.length>0)&&g<n||this._scrollUp.didScrollUpOrDown?this._scrollUp.runIgnored(()=>{t.restore(this.editor)}):this._scrollUp.runIgnored(()=>{t.restore(this.editor);const r=this.editor.getScrollTop(),s=this.editor.getTopForLineNumber(i),p=s-this._computeHeight().pixelsValue,h=this.editor.getLayoutInfo().height,_=this.editor.getBottomForLineNumber(i);let u=p,v=!1;_>=r+h&&(u=_-h,v=!0),(u<r||v)&&(this._logService.trace("[IE] REVEAL zone",{zoneTop:p,lineTop:s,lineBottom:_,scrollTop:r,newScrollTop:u,forceScrollTop:v}),this.editor.setScrollTop(u,b.Immediate))})}revealRange(e,t){}_getWidth(e){return e.width-e.minimap.minimapWidth}hide(){const e=I.capture(this.editor);this._scrollUp.disable(),this._ctxCursorPosition.reset(),this.widget.reset(),this.widget.chatWidget.setVisible(!1),super.hide(),y.status(A("inlineChatClosed","Closed inline chat widget")),e.restore(this.editor)}};m=f([c(2,W),c(3,D),c(4,U),c(5,H)],m);class q{constructor(o){this._editor=o}_didScrollUpOrDown;_ignoreEvents=!1;_listener=new L;dispose(){this._listener.dispose()}reset(){this._didScrollUpOrDown=void 0}enable(){this._didScrollUpOrDown=void 0,this._listener.value=this._editor.onDidScrollChange(o=>{!o.scrollTopChanged||this._ignoreEvents||(this._listener.clear(),this._didScrollUpOrDown=!0)})}disable(){this._listener.clear(),this._didScrollUpOrDown=void 0}runIgnored(o){return()=>{this._ignoreEvents=!0;try{return o()}finally{this._ignoreEvents=!1}}}get didScrollUpOrDown(){return this._didScrollUpOrDown}}export{m as InlineChatZoneWidget};
